name: Build nekoray

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "LICENSE"
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release Tag"
        required: false
      publish:
        description: "Publish: y to skip"
        required: false

jobs:
  # ─────────────────────────────────────────────
  # Build Go binaries
  # ─────────────────────────────────────────────
  build-go:
    strategy:
      matrix:
        cross_os: [windows, linux]
        cross_arch: [amd64]
        include:
          - cross_os: public_res
            cross_arch: public_res
      fail-fast: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Go Status
        run: git ls-files go | xargs cat | sha1sum > go_status
      - name: Cache Go build
        id: cache-go
        uses: actions/cache@v4
        with:
          path: artifacts.tgz
          key: go-${{ matrix.cross_os }}-${{ matrix.cross_arch }}-${{ hashFiles('libs/*.sh', 'go_status', '*.txt') }}
      - name: Setup Go
        if: steps.cache-go.outputs.cache-hit != 'true'
        uses: actions/setup-go@v5
        with:
          go-version: "^1.22"
      - name: Build
        if: steps.cache-go.outputs.cache-hit != 'true'
        run: |
          if [ "${{ matrix.cross_os }}" = "public_res" ]; then
            ./libs/build_public_res.sh
          else
            ./libs/get_source.sh
            GOOS=${{ matrix.cross_os }} GOARCH=${{ matrix.cross_arch }} ./libs/build_go.sh
          fi
      - name: Tar artifacts
        if: steps.cache-go.outputs.cache-hit != 'true'
        run: tar czvf artifacts.tgz ./deployment
      - uses: actions/upload-artifact@v4
        with:
          name: go-${{ matrix.cross_os }}-${{ matrix.cross_arch }}
          path: artifacts.tgz

  # ─────────────────────────────────────────────
  # Build C++ GUI - Windows (MSYS2 MinGW64 + Qt5)
  # ─────────────────────────────────────────────
  build-cpp-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-qt5-base
            mingw-w64-x86_64-qt5-svg
            mingw-w64-x86_64-qt5-tools
            mingw-w64-x86_64-protobuf
            mingw-w64-x86_64-yaml-cpp
            mingw-w64-x86_64-zxing-cpp
            mingw-w64-x86_64-ntldd
      - name: Build C++
        run: |
          mkdir -p build && cd build
          cmake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DNKR_DISABLE_LIBS=ON \
            -DQT_VERSION_MAJOR=5 \
            ..
          ninja
      - name: Deploy
        run: |
          source libs/env_deploy.sh
          DEST=$DEPLOYMENT/windows64
          mkdir -p $DEST
          cp build/newbeeplus.exe $DEST/
          cd $DEST
          windeployqt-qt5.exe newbeeplus.exe --no-compiler-runtime --no-opengl-sw || true
          rm -rf translations
          rm -f libEGL.dll libGLESv2.dll
          # Qt plugins
          QT_PLUGIN_DIR="/mingw64/share/qt5/plugins"
          mkdir -p platforms iconengines imageformats styles
          cp $QT_PLUGIN_DIR/platforms/qwindows.dll platforms/
          cp $QT_PLUGIN_DIR/iconengines/*.dll iconengines/ 2>/dev/null || true
          cp $QT_PLUGIN_DIR/imageformats/*.dll imageformats/ 2>/dev/null || true
          cp $QT_PLUGIN_DIR/styles/*.dll styles/ 2>/dev/null || true
          # 自动收集所有 MinGW DLL 依赖
          cd $OLDPWD
          bash libs/collect_dlls_mingw.sh $DEST
      - name: Tar artifacts
        run: tar czvf artifacts.tgz ./deployment
      - uses: actions/upload-artifact@v4
        with:
          name: cpp-windows-mingw64
          path: artifacts.tgz

  # ─────────────────────────────────────────────
  # Build C++ GUI - Linux (Docker + Qt5)
  # ─────────────────────────────────────────────
  build-cpp-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Cache deps
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: libs/deps
          key: deps-linux-${{ hashFiles('libs/build_deps_*.sh') }}
      - name: Build deps + C++ (Docker)
        run: |
          docker run --rm \
            -v $PWD:/nekoray -w /nekoray \
            ghcr.io/matsuridayo/debian10-qt5:20230131 \
            bash -c "
              [ -d libs/deps/built ] || ./libs/build_deps_all.sh
              mkdir -p build && cd build
              cmake -GNinja -DCMAKE_BUILD_TYPE=Release ..
              ninja
              cd .. && ./libs/deploy_linux64.sh
            "
      - name: Tar artifacts
        run: tar czvf artifacts.tgz ./deployment
      - uses: actions/upload-artifact@v4
        with:
          name: cpp-linux-x64
          path: artifacts.tgz

  # ─────────────────────────────────────────────
  # Pack & Publish Release (manual dispatch only)
  # ─────────────────────────────────────────────
  publish:
    name: Pack & Publish Release
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish != 'y'
    runs-on: ubuntu-latest
    needs:
      - build-cpp-windows
      - build-cpp-linux
      - build-go
    steps:
      - uses: actions/checkout@v4
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: download-artifact
      - name: Pack
        run: |
          curl -Lo - https://github.com/tcnksm/ghr/releases/download/v0.13.0/ghr_v0.13.0_linux_amd64.tar.gz | tar xzv
          mv ghr*linux_amd64/ghr .
          source libs/env_deploy.sh
          find . -name artifacts.tgz | xargs -n1 tar xvzf
          cd deployment
          cp -r public_res/* linux64 2>/dev/null || true
          cp -r public_res/* windows64 2>/dev/null || true
          rm -rf public_res *.pdb
          mv linux64 nekoray
          zip -r $version_standalone-linux64.zip nekoray
          rm -rf nekoray
          mv windows64 nekoray
          zip -r $version_standalone-windows64.zip nekoray
          rm -rf nekoray
      - name: Pack Debian
        run: |
          source libs/env_deploy.sh
          find . -name artifacts.tgz | xargs -n1 tar xvzf
          cd deployment
          cp -r public_res/* linux64 2>/dev/null || true
          bash ../libs/package_debian.sh ${{ github.event.inputs.tag }}
          mv nekoray.deb $version_standalone-debian-x64.deb
          sudo rm -rf nekoray
      - name: Pack AppImage
        run: |
          source libs/env_deploy.sh
          find . -name artifacts.tgz | xargs -n1 tar xvzf
          cd deployment
          cp -r public_res/* linux64 2>/dev/null || true
          bash ../libs/package_appimage.sh
          mv newbeeplus-x86_64.AppImage $version_standalone-linux-x64.AppImage
      - name: Clean Up
        run: |
          cd deployment
          rm -rf linux64 windows64 public_res *.pdb
      - name: Uploading Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Deployment-${{ github.sha }}
          path: deployment
      - name: Release
        if: github.event.inputs.tag
        run: |
          ./ghr -delete -t "${{ github.token }}" -n "${{ github.event.inputs.tag }}" "${{ github.event.inputs.tag }}" deployment
